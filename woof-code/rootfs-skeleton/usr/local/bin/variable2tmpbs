#!/bin/ash

if [ $# -lt 1 -o "$1" = "-h" -o "$1" = "--help" ]; then
	SHBASE="`basename $0`"
	echo "Update <variable-name> entry in BOOT_SPECS"
	echo "Usage: $SHBASE [-h|-q] variable-name [variable-value]"
	echo "Examples with 2 parameters:"
	echo " $SHBASE YDRV \":/puppy/ydrv_overlay.sfs\""
	echo " $SHBASE PNOCOPY yes"
	echo " $SHBASE YDRV"
	echo "Examples with 3 parameters:"
	echo " $SHBASE -q YDRV \":/puppy/ydrv_overlay.sfs\""
	echo " $SHBASE -q PNOCOPY yes"
	echo " $SHBASE -q YDRV"
	echo "If no variable-value is provided, the variable is removed from BOOT_SPECS."
	echo "The \"-q\" parameter suppresses error messages."
	exit 1
fi
if [ "$1" = "-q" ]; then
	QUIET='yes'
	VAR_NAM="$2"
	VAR_VAL="$3"
	exec 2>/dev/null
else
	QUIET=''
	VAR_NAM="$1"
	VAR_VAL="$2"
fi

if [ "$VAR_NAM" = "" ]; then
	[ "$QUIET" ] || echo "Must specify a variable-name"
	exit 1
fi

CONF_FILE="$HOME/.config/boot_specs.conf"
if [ ! -f "$CONF_FILE" ]; then
	bootspecs2tmpbs -q
	if [ ! -f "$CONF_FILE" ]; then
		[ "$QUIET" ] || echo "Configuration file \"${CONF_FILE}\" not found."
		exit 1
	fi
fi
. "$CONF_FILE"
if [ ! -f "$SPECS_FN" ]; then
	bootspecs2tmpbs -q
	[ -f "$CONF_FILE" ] && . "$CONF_FILE" #in case it's modified
	if [ ! -f "$SPECS_FN" ]; then
		[ "$QUIET" ] || echo "Bootspecs file \"${SPECS_FN}\" not found."
		exit 1
	fi
fi

grep -v "^${VAR_NAM}=" "$SPECS_FN" > "${SPECS_FN}.new"
[ "$VAR_VAL" ] && echo "${VAR_NAM}='${VAR_VAL}'" >> "${SPECS_FN}.new"
mv -f "${SPECS_FN}.new" "${SPECS_FN}"
[ "$IN_INITRD" ] || [ "$WAS_MOUNTED" ] && touch "$MOD_FLAG"

exit
